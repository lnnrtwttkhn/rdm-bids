---
title: "`heudiconv` with custom heuristics"
engine: jupyter
jupyter: bash
---

## Introduction

This tutorial is based on [Dianne Patterson's University of Arizona tutorials](https://neuroimaging-core-docs.readthedocs.io/en/latest/pages/heudiconv.html#lesson-3-reproin-py).
It was adapted from the [`heudiconv` Quickstart](https://heudiconv.readthedocs.io/en/latest/quickstart.html) tutorial.
This guide demonstrates how to use `heudiconv` with a provided `heuristic.py` to convert DICOMS into the BIDS data structure using a basic conversion approach.

## Installation

Depending on your environment, paste the installation command here:

```{bash}
# < replace with installation command >
```

## Download the data

Download and extract the example dataset or retrieve it from OSF at <https://osf.io/rghtc/files/mqgzh>.

```{bash}
#| output-fold: true
curl -L https://nx81903.your-storageshare.de/s/fKw8zSoLwGoDmyE/download -o data.zip
unzip -j -o data.zip -d data
rm -f data.zip
```

## Prepare the data

Extract the downloaded archive.
This created the folder `MRIS`.

```{bash}
#| output-fold: true
unzip data/sub-219_dicom.zip
```

## Inspect the raw data structure

Let's examine the directory structure of our dataset.
The dataset contains DICOM files organized by subject and session:

```{bash}
#| output-fold: true
tree -L 2 MRIS
```

## Create the heuristic file

Let's examine the provided heuristic file that defines how to organize the DICOM files:

```{bash}
#| output-fold: true
cat MRIS/Nifti/code/heuristic1.py
```

## Run basic `heudiconv` conversion

Now we'll use heudiconv to convert DICOMS into the BIDS data structure using the custom heuristic.

Here's an explanation of the flags and arguments:

- `--files` specifies the DICOM files to convert
- `-f` provides the heuristic file path
- `-o` tells `heudiconv` where to place output (Nifti directory)
- `-s` specifies the subject ID
- `-ss` specifies the session
- `-c dcm2niix` uses `dcm2niix` converter
- `-b` indicates BIDS format output
- `--minmeta` prevents overflow of meta-information in JSON files
- `--overwrite` overwrites existing converted files

```{bash}
#| output-fold: true
heudiconv --files MRIS/dicom/219/itbs/*/*.dcm -o MRIS/Nifti -f MRIS/Nifti/code/heuristic1.py -s 219 -ss itbs -c dcm2niix -b --minmeta --overwrite
```

## Inspect the BIDS dataset

Let's see what was created in the Nifti directory:

```{bash}
#| output-fold: true
tree MRIS/Nifti
```

The output should contain:

- A BIDS-compliant subject directory (`sub-219/ses-itbs/`)
- Subdirectories for different data types (`anat`, `dwi`, `fmap`, `func`)
- Required BIDS text files (`CHANGES`, `README`, `dataset_description.json`, etc.)

Let's look at the subject structure in more detail:

```{bash}
#| output-fold: true
tree MRIS/Nifti/sub-219
```

## Check BIDS files

Let's examine the required BIDS files that were created:

```{bash}
#| output-fold: true
ls MRIS/Nifti/*.json
```

```{bash}
#| output-fold: true
ls MRIS/Nifti/*.tsv
```

```{bash}
#| output-fold: true
cat MRIS/Nifti/README
```

```{bash}
#| output-fold: true
cat MRIS/Nifti/CHANGES
```

View the dataset description:

```{bash}
#| output-fold: true
cat MRIS/Nifti/dataset_description.json
```

## Validate the BIDS dataset

Validate the dataset using the BIDS Validator to ensure everything is according to specification:

```{bash}
#| output-fold: true
bids-validator-deno MRIS/Nifti
```

The validation should show no errors, though there might be a couple of warnings.

## Understanding the conversion process

Let's examine what types of data were converted by looking at the different modality folders:

### Anatomical data

```{bash}
#| output-fold: true
ls MRIS/Nifti/sub-219/ses-itbs/anat/
```

### Functional data

```{bash}
#| output-fold: true
ls MRIS/Nifti/sub-219/ses-itbs/func/
```

### Diffusion data

```{bash}
#| output-fold: true
ls MRIS/Nifti/sub-219/ses-itbs/dwi/
```

### Diffusion data

```{bash}
#| output-fold: true
ls MRIS/Nifti/sub-219/ses-itbs/fmap/
```

## Examining JSON sidecars

BIDS requires JSON sidecar files alongside NIfTI files.
Let's examine one:

```{bash}
#| output-fold: true
cat MRIS/Nifti/sub-219/ses-itbs/func/sub-219_ses-itbs_task-rest_bold.json
```

## Summary

You have successfully converted DICOM files to BIDS format using a custom heuristic file!

Key differences from Exercise 1 (ReproIn approach):

- Used a custom `heuristic1.py` file instead of the built-in ReproIn heuristic
- Required manual specification of subject and session parameters
- Provides more control over the conversion process
- Suitable for datasets that don't follow ReproIn naming conventions

In future tutorials, you can:

- Learn how to create and modify custom heuristic files for your own data
- Understand how to handle more complex dataset structures
- Explore advanced heudiconv options for specific use cases

Once you have a BIDS-compatible dataset, you can run [BIDS Apps](https://bids-apps.neuroimaging.io/) for further analysis!
