---
date: today
engine: jupyter
jupyter: bash
code-links: binder
---

::: {.callout-note title="Acknowledgements" collapse="true"}

[![](https://zenodo.org/badge/DOI/10.5281/zenodo.4455923.svg)](https://doi.org/10.5281/zenodo.4455923)

This tutorial is inspired by and reuses content from the [Princeton Handbook for Reproducible Neuroimaging](https://brainhack-princeton.github.io/handbook/) by @wagner2021.
The handbook is licensed under a a [CC BY-SA 4.0](https://github.com/brainhack-princeton/handbook/blob/master/LICENSE) license.
:::

## What is BIDS (Brain Imaging Data Structure)?

Many of the best practices we encourage in this handbook revolve around the Brain Imaging Data Structure (BIDS) [@gorgolewski2016].
Neuroimaging research relies on complex multimodal data and different software packages have historically used different naming and organization conventions.
Different labs and different researchers use idiosyncratic conventions—even the same researcher may use different conventions from experiment to experiment.
The goal of [BIDS](https://bids-specification.readthedocs.io/en/stable/) is to create an easy-to-adopt community standard for organizing neuroimaging data.
BIDS facilitates:

- **Data validation**: Data often has "bugs"—just like software.
The [BIDS-Validator](https://github.com/bids-standard/bids-validator) can be used to check the integrity of your BIDS dataset, allowing you to identify potential errors or inconsistencies in the data structure.

- **Collaboration**: By using a standard format, working on data collaboratively within and across labs becomes much easier (no more re-organizing someone else's data).
It also makes it much easier to return to the same dataset years later (your future self will thank you).

- **Data analysis**: The machine-readable format and rich metadata of BIDS allows software packages—such as [fMRIPrep](https://fmriprep.readthedocs.io/) and [MRIQC](https://mriqc.readthedocs.io/en/stable/)—to process BIDS data in an automated fashion.
There is a growing number of software packages—called [BIDS Apps](https://bids-apps.neuroimaging.io/)—that capitalize on BIDS [@gorgolewski2017].

- **Sharing data**: Data sharing is an important element of reproducible science and is encouraged (often enforced!) by many major federal funding agencies (e.g., [NIH](https://grants.nih.gov/grants/policy/data_sharing/), [NSF](https://www.nsf.gov/bfa/dias/policy/dmp.jsp), [ERC](https://erc.europa.eu/managing-project/open-access)).
BIDS allows others to more easily use your data and is the standard used by the [OpenNeuro](https://openneuro.org/) data sharing platform [@poldrack2017].
The workflow in this handbook encourages converting your data to BIDS format as early in the workflow as possible to facilitate reproducibility and save you the energy of retroactively organizing your data at the time of sharing.

Consult the [BIDS Specification](https://bids-specification.readthedocs.io/en/stable/) for detailed documentation on formatting.
If you want to setup a new study using BIDS, check out documentation and scripts for converting raw data to BIDS format.
You can also practice using BIDS with sample datasets.

## Tutorial: Create a BIDS dataset using `heudiconv`

In this tutorial, we will create a BIDS dataset using `heudiconv`.

[HeuDiConv](https://heudiconv.readthedocs.io/en/latest/) is a flexible DICOM converter that helps organize brain imaging data into structured directory layouts.
It converts DICOM files to NIfTI format using customizable heuristics (rules) to determine how files should be named and organized.
HeuDiConv is particularly useful for converting raw scanner data to BIDS format, making your data more standardized and analysis-ready.

::: {.callout-note title="What are key differences between DICOM and NIfTI?" collapse="true"}
**DICOM (Digital Imaging and Communications in Medicine)** is the standard format used by medical imaging devices (CT, MRI, etc.). DICOM files:
- Store images as 2D layers/slices that can be viewed individually
- Include extensive metadata (patient info, acquisition parameters, etc.)
- Are larger and more complex but provide rich clinical information
- Are widely used across all medical specialties

**NIfTI (Neuroimaging Informatics Technology Initiative)** was designed specifically for neuroimaging research. NIfTI files:
- Store 3D volumetric data with clear spatial orientation
- Have less metadata but are simpler and faster to process
- Solve spatial orientation problems that existed in older formats
- Are primarily used in neuroscience and brain research

**Why convert from DICOM to NIfTI?** DICOM files can be converted to NIfTI without losing image quality, making the data easier to work with in research pipelines while maintaining the essential imaging information.
:::

### Create a project directory

Create an empty directory and navigate into it:

```{bash}
mkdir mydataset # <1>
cd mydataset
```

1. `mydataset` is only a name.
You can choose any other name.

### Download the data

Download the data by @nastase2020 from [Zenodo](https://doi.org/10.5281/zenodo.3677089):

::: {.callout-warning title="Download can take ca. 5 Min." appearance="minimal"}
:::

```{bash}
wget https://zenodo.org/record/3677090/files/0219191_mystudy-0219-1114.tar.gz
```

::: {.callout-note title="More about the dataset by @nastase2020" collapse="true"}
This archive contains a raw DICOM dataset acquired (with informed consent) using the ReproIn naming convention on a Siemens Skyra 3T MRI scanner.
The dataset includes a T1-weighted anatomical image, four functional runs with the "prettymouth" spoken story stimulus, and one functional run with a block design emotional faces task, as well as auxiliary scans (e.g., scout, soundcheck).
The "prettymouth" story stimulus created by Yeshurun et al., 2017 and is available as part of the Narratives collection, and the emotional faces task is similar to Chai et al., 2015.
These data are intended for use with the [Princeton Handbook for Reproducible Neuroimaging](https://brainhack-princeton.github.io/handbook/).
The handbook provides guidelines for BIDS conversion and execution of BIDS apps (e.g., fMRIPrep, MRIQC).
The brain data are contributed by author S.A.N. and are authorized for non-anonymized distribution.
:::

### Prepare the data

Now we need to extract the downloaded archive:

```{bash}
tar -xvzf 0219191_mystudy-0219-1114.tar.gz # <1>
```

1. Extract the tar.gz archive (`-x` extract, `-v` verbose, `-z` gzip, `-f` file)

Let's navigate into the directory and see what's inside the dataset:

```{bash}
tree -L 2 0219191_mystudy-0219-1114 # <1>
```

1. Show the directory structure with maximum depth of 2 levels

We need to decompress all gzipped DICOM files in the `dcm` directory:

```{bash}
gunzip 0219191_mystudy-0219-1114/dcm/*.dcm.gz
```

Finally, we can run `heudiconv`!
The following command converts DICOM files to BIDS format using the ReproIn heuristic for subject 01, session 01

### Run `heudiconv`

```{bash}
heudiconv -f reproin --subject 01 --ses 01 --bids --files 0219191_mystudy-0219-1114/dcm --overwrite
```

- `-f reproin` specifies the converter file to use
- `--subject 01` specifies the subject
- `--ses 01` specifies the subject
- `--bids` is a flag for output into BIDS structure
- `--files` or directories containing files to process
- `--overwrite ` overwrites existing converted files

### Validating a BIDS Dataset

Let's see what was created:

```{bash}
ls
```

Let's inspect the new folder in more detail:

```{bash}
tree -L 7 Norman
```

That looks like a BIDS dataset!
Let's check using the [BIDS Validator](https://bids-standard.github.io/bids-validator/):

```{bash}
cd Norman/Mennen/5516_greenEyes/
bids-validator-deno .
```

Let the BIDS validator ignore `/sourcedata` and `.heudiconv`:

```{bash}
touch .bidsignore
echo "/sourcedata" > .bidsignore
echo ".heudiconv" >> .bidsignore
```

### Fixing a BIDS Dataset

The BIDS Validator found several errors and issued a number of warnings.
This means the dataset is not yet fully BIDS-compliant.
You need to manually adjust the relevant files to fix these issues.
Start by addressing the errors first.
Errors make your dataset BIDS-incompatible and must be resolved for proper validation.
Many [BIDS Apps](https://bids-apps.neuroimaging.io/) (like [fMRIPrep](https://fmriprep.org/en/stable/) and [MRIQC](https://mriqc.readthedocs.io/en/latest/)) require datasets to be error-free they can run.
Warnings indicate that your dataset is technically BIDS-compliant, but improvements are recommended.
You should try to resolve all warnings to ensure your dataset is robust and ready for downstream analysis.

#### Remove data from the MRI loalizer

::: {.callout-tip title="What is an MRI Localizer (Scout) scan?" collapse="true"}
An **MRI localizer** (also called a *scout* or *survey* scan) is a quick, low-resolution scan done at the start of an MRI session.
Its main purpose is to help plan and position the detailed scans that follow.
Localizers show the basic anatomy and orientation, but are not used for diagnosis or analysis.
:::

```{bash}
rm -rf sub-*/ses-*/*/*scout*
```

#### Remove repeated runs (resulting in duplications)

```{bash}
rm -rf sub-*/ses-*/*/*_dup*
```

#### Adjust the `scans.tsv` file:

```{python}
import pandas as pd # <1>
df = pd.read_csv('sub-01/ses-01/sub-01_ses-01_scans.tsv', sep='\t') # <2>
df_clean = df[~df['filename'].str.contains('_dup')] # <3>
df_clean = df_clean[~df_clean['filename'].str.contains('scout')] # <4>
df_clean.to_csv('sub-01/ses-01/sub-01_ses-01_scans.tsv', sep='\t', index=False) # <5>
```

1. Import the `pandas` library for data manipulation.
2. Load the scans TSV file into a DataFrame.
3. Remove rows where the `'filename'` column contains `'_dup'` (duplicate runs).
4. Further remove rows where `'filename'` contains `'scout'` (localizer scans).
5. Save the cleaned DataFrame back to the original TSV file, overwriting it.

### Validate again

Run the BIDS Validator repeatedly to verify that you resolved remaining errors and warnings:

```{bash}
bids-validator-deno .
```

Cool, at least no errors!

## What's next?

Once you have a fully BIDS-compatible dataset, you can run [BIDS Apps](https://bids-apps.neuroimaging.io/) (like [fMRIPrep](https://fmriprep.org/en/stable/) and [MRIQC](https://mriqc.readthedocs.io/en/latest/)) and more!
And you have a well-documented dataset that follows best community practices!
Congrats!

## Resources

- [BIDS Specification](https://bids-specification.readthedocs.io/en/stable/)
- [BIDS Validator](https://bids-standard.github.io/bids-validator/)
- [BIDS Validator on GitHub](https://github.com/bids-standard/bids-validator)
- [BIDS Apps](https://bids-apps.neuroimaging.io/)
- [OpenNeuro](https://openneuro.org/)
- [fMRIPrep](https://fmriprep.readthedocs.io/)
- [MRIQC](https://mriqc.readthedocs.io/en/stable/)
- [National Institutes of Health (NIH) Data Sharing Policy](https://grants.nih.gov/grants/policy/data_sharing/)
- [National Science Foundation (NSF) Dissemination and Sharing of Research Results](https://www.nsf.gov/bfa/dias/policy/dmp.jsp)
- [European Research Council (ERC) Open Science](https://erc.europa.eu/manage-your-project/open-science)
- [DFG: Handling of Research Data](https://www.dfg.de/en/research-funding/funding-initiative/research-data)

## References

:::{#refs}
:::

## Execution

- Python: `{{< env QUARTO_PYTHON >}}`
- Profile: `{{< env QUARTO_PROFILE >}}`
